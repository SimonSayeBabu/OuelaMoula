<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OuÃ©lamoula</title>
    <link rel="icon" type="image" href="/src/img/icon.svg">
    <script type="text/javascript" src="./leaflet/leaflet.js"></script>
    <script
      type="text/javascript"
      src="./leaflet/leaflet.markercluster.js"
    ></script>
    <link rel="stylesheet" href="./styles/style.css" />
    <script type="text/javascript" src="./scripts/main.js"></script>
    <script>
      "use strict";

      window.addEventListener("resize", () => {
        document.getElementById("map").style.width = window.innerWidth + "px";
        document.getElementById("map").style.height = window.innerHeight + "px";
      });

      window.onload = async () => {
        let map = L.map("map", {
          center: [48.856667, 2.352222],
          zoom: 5,
          minZoom: 2,
          zoomControl: false,
          maxBounds: [
            [90, 160],
            [-90, -220],
          ],
        });

        L.control
          .zoom({
            position: "topright",
          })
          .addTo(map);

        let modeChanger = document.getElementById("mode");
        let mode = -1;

        modeChanger.addEventListener("change", (event) => {
          map.removeLayer(mapLayer);
          mode *= -1;
          mapLayer = setLayer(mode);
        });

        let search = document.getElementById("search");
        search.addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            if (search.value) {
              searchBillionaire(search.value);
            } else {
              removeGeoLayer();
              geoLayer = createGeoLayer(data, "", "", "");
            }
          }
        });

        let filtersOpen = false;

        const filterState = {
          gender: { m:false, f:false },
          selfMade: null,
          family: null,
          rank: null,
          networth: null,
        };

        const left = document.getElementById("left");
        const filtersToggle = document.getElementById("filtersToggle");
        const filtersPanel = document.getElementById("filtersPanel");
        const cardContent = document.getElementById("cardContent");

        filtersToggle.addEventListener("click", () => {
          filtersOpen = !filtersOpen;
          filtersPanel.classList.toggle("hidden", !filtersOpen);
          left.classList.toggle("filters-open", filtersOpen);
          filtersToggle.textContent = filtersOpen ? "â–´" : "â–¾";
          removeGeoLayer();
          geoLayer = createGeoLayer("", "ui", search.value || "");
          geoLayer.addTo(map);
        });

        filtersPanel.addEventListener("change", (e) => {
          const el = e.target;
          if (!(el instanceof HTMLInputElement)) return;
          const token = el.dataset.filter;
          if (!token) return;

          const [k, v] = token.split(":");
          if (k === "gender") filterState.gender[v] = el.checked;
          if (k === "selfMade") filterState.selfMade = el.checked ? true : null;
          if (k === "family") filterState.family = el.checked ? true : null;
          if (k === "rank") filterState.rank = el.checked ? v : null;
          if (k === "networth") filterState.networth = el.checked ? v : null;

          removeGeoLayer();
          geoLayer = createGeoLayer("", "ui", search.value || "");
          geoLayer.addTo(map);
        });

        // Layer de base
        let mapLayer = setLayer("dark");

        // Layer des data
        let response = await fetch("./src/data/result.geojson");
        let data = await response.json();
        let geoLayer = createGeoLayer(data, "", "citizenship", "fr");
        geoLayer.addTo(map);

        // Fonctions
        function setLayer(mode) {
          var layer;
          if (mode == 1) {
            layer = L.tileLayer(
              "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}",
              {
                minZoom: 0,
                maxZoom: 20,
                attribution:
                  '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                ext: "png",
              },
            );
          } else {
            layer = L.tileLayer(
              "https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.{ext}",
              {
                minZoom: 0,
                maxZoom: 20,
                attribution:
                  '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                ext: "png",
              },
            );
          }
          layer.addTo(map);
          return layer;
        }

        function createGeoLayer(type, filter, prop) {
          let markers = L.markerClusterGroup();
          L.geoJson(data, {
            filter: function (geoJsonFeature) {
              const p = geoJsonFeature.properties;

              if (prop && (filter === "name" || filter === "ui")) {
                if (!p.name?.toLowerCase().includes(prop.toLowerCase())) return false;
              }

              const wantM = filterState.gender.m;
              const wantF = filterState.gender.f;
              if (wantM || wantF) {
                if (p.gender === "m" && !wantM) return false;
                if (p.gender === "f" && !wantF) return false;
                if (p.gender !== "m" && p.gender !== "f") return false;
              }

              if (filterState.selfMade === true && !(p.selfMade && p.selfMade._is === true)) return false;
              if (filterState.family === true && p.family !== true) return false;

              if (filterState.rank === "top100" && !(p.rank <= 100)) return false;
              if (filterState.rank === "top500" && !(p.rank <= 500)) return false;

              if (filterState.networth === "gt10" && !(p.networth >= 10000)) return false;
              if (filterState.networth === "gt50" && !(p.networth >= 50000)) return false;

              return true;
            },
            pointToLayer: function (geoJsonPoint, latlng) {
              let marker;
              if (type == "money") {
                marker = L.circle(latlng, {
                  radius:
                    40 *
                    fromSurfaceValue(
                      (geoJsonPoint.properties[""] / max) * toSurface(maxMap),
                    ),
                  fillColor: "#FF1111",
                  color: "#FF1111",
                });
              } else {
                var icon = new L.Icon({
                  iconUrl: "./src/img/single_marker.png",
                  iconSize: [25, 25],
                  iconAnchor: [12.5, 12.5],
                });
                marker = L.marker(latlng, {
                  icon: icon,
                  title: geoJsonPoint.properties["name"],
                });
              }
              marker.on('click', function(event) {
                onMarkerClick(geoJsonPoint);
              });
              markers.addLayer(marker);
            },
          });
          markers.addTo(map);
          return markers;
        }

        function onMarkerClick(feature) {
          const p = feature.properties;
          const cardContent = document.getElementById("cardContent");

          const residence = p.residence
            ? [p.residence.city, p.residence.state, p.residence.country]
                .filter(Boolean)
                .join(", ")
            : "â€”";

          const industries = Array.isArray(p.industry) && p.industry.length
            ? p.industry.join(", ")
            : "â€”";

          const sources = Array.isArray(p.source) && p.source.length
            ? p.source.join(", ")
            : "â€”";

          const selfMade = p.selfMade?._is ? "Oui" : "Non";
          const family = p.family ? "Oui" : "Non";

          const networthB = typeof p.networth === "number"
            ? (p.networth / 1000).toFixed(2)
            : "â€”";

          const avatar = p.image
            ? `<img class="cardAvatar" src="${p.image}" alt="${p.name}"
                onerror="this.outerHTML='<div class=\\'cardAvatar placeholder\\'>ðŸ‘¤</div>'">`
            : `<img class="cardAvatar" src="https://commons.wikimedia.org/wiki/File:Portrait_Placeholder.png" alt="${p.name}"
                onerror="this.outerHTML='<div class=\\'cardAvatar placeholder\\'>ðŸ‘¤</div>'">`;

          cardContent.innerHTML = `
            <div class="cardHeader">
              ${avatar}
              <div>
                <div style="font-weight:700;font-size:1.1rem;">${p.name ?? "â€”"}</div>
                <div style="opacity:.75;font-size:.9rem;">#${p.rank ?? "â€”"}</div>
              </div>
            </div>

            <div style="margin-top:1rem;display:grid;gap:.35rem;font-size:.92rem;">
              <div><span style="opacity:.7;">Fortune :</span> ${networthB} B$</div>
              <div><span style="opacity:.7;">CitoyennetÃ© :</span> ${(p.citizenship ?? "â€”").toUpperCase()}</div>
              <div><span style="opacity:.7;">RÃ©sidence :</span> ${residence}</div>
              <div><span style="opacity:.7;">Genre :</span> ${p.gender === "m" ? "Homme" : p.gender === "f" ? "Femme" : "â€”"}</div>
              <div><span style="opacity:.7;">Naissance :</span> ${p.birthDate ?? "â€”"}</div>
              <div><span style="opacity:.7;">Enfants :</span> ${p.children ?? "â€”"}</div>
              <div><span style="opacity:.7;">Mariage :</span> ${p.maritalStatus ?? "â€”"}</div>
              <div><span style="opacity:.7;">Self-made :</span> ${selfMade}</div>
              <div><span style="opacity:.7;">Famille :</span> ${family}</div>
              <div><span style="opacity:.7;">Industrie :</span> ${industries}</div>
              <div><span style="opacity:.7;">Source :</span> ${sources}</div>
            </div>
          `;
        }


        function removeGeoLayer() {
          map.removeLayer(geoLayer);
        }

        function searchBillionaire(name) {
          removeGeoLayer();
          geoLayer = createGeoLayer("", "name", name);
        }

      };
    </script>
  </head>
  <body>
    <label class="switch">
      <input id="mode" type="checkbox" />
      <span class="slider round"></span>
    </label>
    <div id="left">
      <div id="searchBox" class="">
        <div id="searchBar">
          <input type="text" id="search" placeholder="Elon musk..." />
          <button id="filtersToggle" type="button" aria-label="Filtres" title="Filtres">â–¾</button>
        </div>

        <div id="filtersPanel" class="hidden">
          <div class="filtersGrid">
            <label><input type="checkbox" data-filter="gender:f" /> Femmes</label>
            <label><input type="checkbox" data-filter="gender:m" /> Hommes</label>

            <label><input type="checkbox" data-filter="selfMade:true" /> Self-made</label>
            <label><input type="checkbox" data-filter="family:true" /> HÃ©ritiers / famille</label>

            <label><input type="checkbox" data-filter="rank:top100" /> Top 100</label>
            <label><input type="checkbox" data-filter="rank:top500" /> Top 500</label>

            <label><input type="checkbox" data-filter="networth:gt10" /> Fortune &gt; 10B</label>
            <label><input type="checkbox" data-filter="networth:gt50" /> Fortune &gt; 50B</label>
          </div>
        </div>
      </div>
      <div id="card"><div id="cardContent" style="padding:1rem;color:#fff;">Cliquez sur un markerâ€¦</div></div>
    </div>
    <div id="map"></div>
  </body>
</html>
